global
    log stdout local0
    maxconn 4096
    daemon
    
defaults
    mode http
    log global
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    stats enable
    stats uri /stats
    stats refresh 30s
    
# Frontend pour les agents LiveKit
frontend livekit_agents
    bind *:8080
    mode http
    option forwardfor
    
    # Routing basé sur les headers
    acl is_health_check path /health
    acl is_metrics path /metrics
    acl is_agent_api path_beg /api/agent
    
    # Utiliser le backend approprié
    use_backend agents_health if is_health_check
    use_backend agents_metrics if is_metrics
    default_backend agents_pool
    
# Backend pool d'agents avec load balancing
backend agents_pool
    mode http
    balance roundrobin
    option httpchk GET /health
    
    # Agents avec health check
    server agent1 livekit-agent-1:8080 check inter 5s rise 2 fall 3
    server agent2 livekit-agent-2:8080 check inter 5s rise 2 fall 3
    server agent3 livekit-agent-3:8080 check inter 5s rise 2 fall 3
    server agent4 livekit-agent-4:8080 check inter 5s rise 2 fall 3
    
# Backend pour health checks
backend agents_health
    mode http
    server agent1 livekit-agent-1:8080
    server agent2 livekit-agent-2:8080
    server agent3 livekit-agent-3:8080
    server agent4 livekit-agent-4:8080
    
# Backend pour métriques Prometheus
backend agents_metrics
    mode http
    server agent1_metrics livekit-agent-1:9091
    server agent2_metrics livekit-agent-2:9092
    server agent3_metrics livekit-agent-3:9093
    server agent4_metrics livekit-agent-4:9094
